<h1>Calendario <%= @year %></h1>

<div class="calendar">
  <%= month_calendar(date: Date.today) do |date| %>
    <div class="day-cell" data-date="<%= date %>">
      <div class="day-number"><%= date.day %></div>
      <div class="markings">
        <%# Rende il partial per le marcature relative a questo giorno %>
        <%= render partial: 'calendars/markings', locals: { date: date } %>
      </div>
    </div>
  <% end %>
</div>

<script>
document.addEventListener('turbolinks:load', () => {
  console.log("‚úÖ Turbolinks load event received");

  document.querySelectorAll('.day-cell').forEach(cell => {
    console.log("üîç Found day-cell:", cell);

    cell.addEventListener('click', () => {
      const date = cell.getAttribute('data-date');
      console.log("üìÖ Clicked on date:", date);

      fetch("<%= toggle_day_marking_path %>", {
        method: "POST",
        headers: {
          "X-CSRF-Token": "<%= form_authenticity_token %>",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ date: date })
      })
      .then(response => {
        console.log("üì© Received response:", response);
        return response.json();
      })
      .then(data => {
        console.log("üìú Parsed JSON response:", data);
        
        // Controlla se la chiave `html` √® presente nella risposta
        if (data.html) {
          cell.querySelector('.markings').innerHTML = data.html;
          console.log("‚úÖ Successfully updated markings for", date);
        } else {
          console.error("‚ùå No HTML returned from server!", data);
        }
      })
      .catch(error => {
        console.error("‚ö†Ô∏è Fetch error:", error);
      });
    });
  });
});
</script>
